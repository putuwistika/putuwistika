name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Checkout Code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üîß Install Dependencies
        run: npm ci

      - name: üèóÔ∏è Build Application
        run: npm run build

      - name: ‚úÖ Run Tests
        run: npm test --if-present

      - name: üîë Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: üì¶ Package Build Artifacts
        run: |
          tar -czf build.tar.gz \
            .next \
            public \
            package.json \
            package-lock.json \
            next.config.mjs \
            Dockerfile \
            .dockerignore

      - name: üì§ Deploy to VPS (Zero Downtime with Docker)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts

          # Transfer build artifacts (cepat, cuma ~20MB)
          scp -P $VPS_PORT build.tar.gz $VPS_USERNAME@$VPS_HOST:/var/www/putuwistika/

          # Deploy with Docker (zero downtime)
          ssh -p $VPS_PORT $VPS_USERNAME@$VPS_HOST << 'ENDSSH'
            set -e
            cd /var/www/putuwistika

            # Extract build
            tar -xzf build.tar.gz
            rm build.tar.gz

            # Build new image (with cache, cepat)
            docker build -t putuwistika:new .

            # Start container baru di background
            docker run -d \
              --name putuwistika-new \
              --network host \
              -e PORT=3001 \
              putuwistika:new

            # Health check container baru
            sleep 5
            if curl -f http://localhost:3001 > /dev/null 2>&1; then
              echo "‚úÖ New container healthy!"

              # Switch port & stop old container
              docker stop putuwistika 2>/dev/null || true
              docker rm putuwistika 2>/dev/null || true
              docker stop putuwistika-new

              # Start dengan port production
              docker run -d \
                --name putuwistika \
                --restart unless-stopped \
                --network host \
                -e PORT=3000 \
                putuwistika:new

              # Cleanup
              docker rmi putuwistika:old 2>/dev/null || true
              docker tag putuwistika:new putuwistika:old
              docker rm putuwistika-new 2>/dev/null || true

              echo "üéâ Zero-downtime deployment complete!"
            else
              echo "‚ùå Health check failed!"
              docker stop putuwistika-new
              docker rm putuwistika-new
              exit 1
            fi
          ENDSSH
